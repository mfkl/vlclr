# libvlccore C# Bindings Specification

## Overview

This spec covers the autogeneration of C# bindings for `libvlccore`, enabling the C# plugin to call back into VLC for services like logging, variables, and events.

## Binding Generator

**Tool**: ClangSharp / ClangSharpPInvokeGenerator

### Installation
```bash
dotnet tool install --global ClangSharpPInvokeGenerator
```

### Why ClangSharp
- Parses C headers accurately using libclang
- Generates idiomatic C# P/Invoke declarations
- Handles complex type definitions (macros, nested structs)
- Actively maintained, supports .NET 8+

## Source Headers

### Primary Headers (from `vlc/include/vlc/`)

| Header | Purpose |
|--------|---------|
| `vlc_common.h` | Core types (`vlc_object_t`, `vlc_tick_t`) |
| `vlc_plugin.h` | Plugin macros (for reference) |
| `vlc_interface.h` | Interface plugin specifics |
| `vlc_variables.h` | Variable system (`var_Create`, `var_Set*`, `var_Get*`) |
| `vlc_threads.h` | Threading primitives |
| `vlc_messages.h` | Logging (`msg_Info`, `msg_Warn`, `msg_Err`) |
| `vlc_events.h` | Event system |
| `vlc_objects.h` | Object tree management |

### Configuration File

Create `src/VlcPlugin/clangsharp.rsp`:

```
--file
vlc/include/vlc/libvlc.h
vlc/include/vlc/vlc_common.h
vlc/include/vlc/vlc_variables.h
vlc/include/vlc/vlc_messages.h

--include-directory
vlc/include

--output
src/VlcPlugin/Generated/

--namespace
VlcPlugin.Native

--libraryPath
libvlccore

--methodClassName
VlcCore

--with-type
vlc_object_t*=nint
vlc_tick_t=long
bool=int

--exclude
__.*
_.*

--config
generate-file-scoped-namespaces
generate-helper-types
preview-codegen
```

### Generate Command
```bash
ClangSharpPInvokeGenerator @src/VlcPlugin/clangsharp.rsp
```

## Output Structure

```
src/VlcPlugin/Generated/
├── VlcCore.cs          # Main P/Invoke declarations
├── VlcTypes.cs         # Type definitions (enums, structs)
└── VlcConstants.cs     # Macro constants
```

## Expected Generated Code

### VlcCore.cs (Example)
```csharp
// Auto-generated by ClangSharp

namespace VlcPlugin.Native;

public static unsafe partial class VlcCore
{
    private const string LibraryName = "libvlccore";

    /// <summary>Create a VLC variable</summary>
    [DllImport(LibraryName, CallingConvention = CallingConvention.Cdecl)]
    public static extern int var_Create(
        nint p_obj,
        [MarshalAs(UnmanagedType.LPUTF8Str)] string psz_name,
        int i_type
    );

    /// <summary>Set an integer variable</summary>
    [DllImport(LibraryName, CallingConvention = CallingConvention.Cdecl)]
    public static extern int var_SetInteger(
        nint p_obj,
        [MarshalAs(UnmanagedType.LPUTF8Str)] string psz_name,
        long i_int
    );

    /// <summary>Get an integer variable</summary>
    [DllImport(LibraryName, CallingConvention = CallingConvention.Cdecl)]
    public static extern long var_GetInteger(
        nint p_obj,
        [MarshalAs(UnmanagedType.LPUTF8Str)] string psz_name
    );
}
```

### VlcTypes.cs (Example)
```csharp
namespace VlcPlugin.Native;

/// <summary>Variable types</summary>
public enum VlcVarType
{
    VLC_VAR_BOOL = 1,
    VLC_VAR_INTEGER = 2,
    VLC_VAR_STRING = 3,
    VLC_VAR_FLOAT = 4,
    VLC_VAR_ADDRESS = 5,
    VLC_VAR_COORDS = 6,
}
```

## Priority Functions to Bind

### Phase 1: Minimal Viable (for simple plugin)

1. **Logging**
   - `msg_GenericVa` or similar (VLC 4.x logging)
   - Allows plugin to log to VLC's logging system

2. **Variables**
   - `var_Create` - Create a variable
   - `var_SetInteger`, `var_GetInteger`
   - `var_SetString`, `var_GetString`

3. **Object Management**
   - `vlc_object_parent` - Get parent object
   - `vlc_object_find_name` - Find named object

### Phase 2: Extended (for interactive plugin)

4. **Events**
   - `vlc_event_attach` - Subscribe to events
   - `vlc_event_detach` - Unsubscribe

5. **Playlist/Media**
   - Basic playlist access if needed

### Phase 3: Subtitle Renderer (future)

6. **Text Rendering**
   - `subpicture_*` functions
   - Text style structures

## Manual Wrappers

For better usability, create manual wrappers around generated code:

### VlcLogger.cs
```csharp
namespace VlcPlugin;

/// <summary>
/// High-level wrapper for VLC logging.
/// </summary>
public static class VlcLogger
{
    public static void Info(nint vlcObject, string message)
    {
        // Note: VLC 4.x logging API may differ, adjust as needed
        // This is a placeholder for the actual implementation
        Console.WriteLine($"[VLC Info] {message}");
    }

    public static void Warn(nint vlcObject, string message)
    {
        Console.WriteLine($"[VLC Warn] {message}");
    }

    public static void Error(nint vlcObject, string message)
    {
        Console.WriteLine($"[VLC Error] {message}");
    }
}
```

### VlcVariable.cs
```csharp
using VlcPlugin.Native;

namespace VlcPlugin;

/// <summary>
/// High-level wrapper for VLC variable system.
/// </summary>
public static class VlcVariable
{
    public static void CreateInteger(nint obj, string name, long initialValue = 0)
    {
        VlcCore.var_Create(obj, name, (int)VlcVarType.VLC_VAR_INTEGER);
        VlcCore.var_SetInteger(obj, name, initialValue);
    }

    public static long GetInteger(nint obj, string name)
    {
        return VlcCore.var_GetInteger(obj, name);
    }

    public static void SetInteger(nint obj, string name, long value)
    {
        VlcCore.var_SetInteger(obj, name, value);
    }
}
```

## AOT Compatibility

### Trim Safety
Generated bindings must work with AOT trimming:

```xml
<!-- In VlcPlugin.csproj -->
<ItemGroup>
  <TrimmerRootAssembly Include="VlcPlugin" />
</ItemGroup>
```

### Direct P/Invoke
For AOT, prefer direct P/Invoke over `NativeLibrary.Load`:

```xml
<ItemGroup>
  <DirectPInvoke Include="libvlccore" />
</ItemGroup>
```

## Build Integration

### Regenerate Bindings (when VLC headers change)
```bash
ClangSharpPInvokeGenerator @src/VlcPlugin/clangsharp.rsp
```

### Verify Bindings Compile
```bash
dotnet build src/VlcPlugin
```

## Testing Generated Bindings

### Unit Test (Mock)
```csharp
public class VlcCoreBindingsTests
{
    [Fact]
    public void VarCreate_Declaration_IsCorrect()
    {
        // Verify method signature exists and compiles
        // Actual call requires libvlccore loaded
        var method = typeof(VlcCore).GetMethod("var_Create");
        Assert.NotNull(method);
        Assert.Equal(typeof(int), method.ReturnType);
    }
}
```

### Integration Test (requires VLC)
```csharp
public class VlcIntegrationTests
{
    [Fact]
    [Trait("Category", "Integration")]
    public void VarCreate_WithValidObject_ReturnsSuccess()
    {
        // This test requires VLC to be loaded
        // Skip if libvlccore not available
    }
}
```

## Versioning Considerations

### VLC 4.x API Changes
- VLC 4.x may have API changes from VLC 3.x
- Monitor `vlc/include/vlc/` for header changes
- Regenerate bindings when updating VLC source

### Binding Stability
- Keep generated files in source control
- Document which VLC commit was used for generation
- Consider versioning the bindings separately

## Acceptance Criteria

1. ClangSharp successfully parses VLC headers
2. Generated code compiles without errors
3. P/Invoke declarations match VLC function signatures
4. Type mappings are correct (sizes, alignment)
5. AOT-compatible (no runtime code generation)
6. Trim-safe (no reflection issues)
7. Manual wrappers provide usable API
8. Works when loaded alongside libvlccore
9. Handles VLC 4.x specific API
10. Documented regeneration process
