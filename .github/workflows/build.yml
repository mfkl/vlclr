name: Build and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VLC_SDK_URL: https://artifacts.videolan.org/vlc/nightly-win64-llvm/20260127-0438/vlc-4.0.0-dev-win64-2deb1c14.7z

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Download and extract VLC SDK
        run: |
          Invoke-WebRequest -Uri "$env:VLC_SDK_URL" -OutFile vlc.7z
          7z x vlc.7z -ovlc-download
          # Move the inner folder to vlc-sdk
          $innerFolder = Get-ChildItem vlc-download | Select-Object -First 1
          Move-Item $innerFolder.FullName vlc-sdk

      - name: Add vswhere to PATH
        run: |
          $vsWherePath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer"
          echo "$vsWherePath" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Restore dependencies
        run: dotnet restore

      - name: Build VLCLR framework
        run: dotnet build src/VLCLR -c Release

      - name: Build VideoOverlay sample (Native AOT)
        run: dotnet publish samples/VideoOverlay -c Release -r win-x64

      - name: Run tests
        run: dotnet test src/VLCLR.Tests -c Release --logger trx --results-directory TestResults

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults/*.trx

      - name: Deploy plugin to VLC
        run: |
          $pluginSrc = "samples/VideoOverlay/bin/Release/net10.0/win-x64/native/libdotnet_overlay_plugin.dll"
          $pluginDst = "vlc-sdk/plugins/video_filter/"
          New-Item -ItemType Directory -Force -Path $pluginDst
          Copy-Item $pluginSrc $pluginDst
          Write-Host "Plugin deployed to $pluginDst"

      - name: Regenerate VLC plugin cache
        run: |
          & "vlc-sdk/vlc-cache-gen.exe" "vlc-sdk/plugins"

      - name: Run filter integration test
        run: |
          ./build-and-test.ps1 `
            -SkipBuild `
            -SkipCacheRegen `
            -VlcBinaryPath "vlc-sdk" `
            -VideoPath "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" `
            -TestTimeout 30

      - name: Upload plugin
        uses: actions/upload-artifact@v4
        with:
          name: plugins
          path: |
            samples/VideoOverlay/bin/Release/net10.0/win-x64/native/libdotnet_overlay_plugin.dll
