# Implementation Plan

> Generated by planning phase. VLC 4.x API version: 4.0.6

## Current Goal - ACHIEVED

**Get a C# log message to appear in real VLC 4 logs.**

Drop both DLLs into a VLC 4 installation and see "C# Plugin initialized" in VLC's log output.

Phase 3 (Player Events Integration) is now complete.

### Success Criteria Met
- [x] Plugin loads in VLC 4
- [x] C# log messages appear in VLC log output
- [x] Variable creation works

## Architecture

```
VLC 4.x Plugin System
        │
        ▼
┌──────────────────────────┐
│  libhello_csharp_plugin  │  C glue (VLC-facing)
│  - vlc_module_begin/end  │
│  - Open() → bridges to   │──────┐
│  - Close() → C# exports  │      │
└──────────────────────────┘      │
                                  │ LoadLibrary + GetProcAddress
                                  ▼
┌──────────────────────────┐
│  VlcPlugin.dll (native)  │  C# Native AOT
│  - CSharpPluginOpen()    │
│  - CSharpPluginClose()   │
│  - Logs via bridge       │──────┐
└──────────────────────────┘      │
                                  │ P/Invoke callback
                                  ▼
                      csharp_bridge_log() in C glue
                                  │
                                  ▼
                          vlc_object_Log() in libvlccore.dll
```

---

## Deployment Target

```
vlc-4.0.0-dev/
├── vlc.exe
├── libvlccore.dll
└── plugins/
    └── control/
        ├── libhello_csharp_plugin.dll   ← C glue (copy here)
        └── VlcPlugin.dll                 ← C# Native AOT (copy here)
```

---

## Phase 1: Minimal Viable Plugin - COMPLETED

### Priority 1: C# Native AOT Project Setup - COMPLETED
- [x] Create `src/VlcPlugin/VlcPlugin.csproj` with .NET 10, PublishAot=true
- [x] Create `src/VlcPlugin/PluginExports.cs` with `[UnmanagedCallersOnly]` exports
- [x] Create `src/VlcPlugin/PluginState.cs` for state management
- [x] Verify `dotnet publish -c Release -r win-x64` produces native DLL

### Priority 2: C Glue Layer - COMPLETED
- [x] Create `src/glue/plugin_entry.c` with VLC module macros
- [x] Create `src/glue/csharp_bridge.c` - dynamic loading of VlcPlugin.dll
- [x] Create `src/glue/vlccore_stub.c` - stub for testing without VLC

### Priority 3: Bridge Integration - COMPLETED
- [x] Implement Open/Close callbacks that bridge to C#
- [x] Test with standalone test harness

---

## Phase 2: Real VLC Integration - COMPLETED

### Priority 4: Link Against Real libvlccore - COMPLETED
- [x] Rebuild C glue WITHOUT vlccore_stub.c
- [x] Link against `libvlccore.dll` from VLC binaries
- [x] Build command: `clang -shared -o libhello_csharp_plugin.dll src/glue/plugin_entry.c src/glue/csharp_bridge.c -I./vlc/include -L./vlc-binaries/vlc-4.0.0-dev -lvlccore`

### Priority 5: Deploy and Test - COMPLETED
- [x] Copy `libhello_csharp_plugin.dll` to `vlc-binaries/vlc-4.0.0-dev/plugins/control/`
- [x] Copy `VlcPlugin.dll` to `vlc-binaries/vlc-4.0.0-dev/plugins/control/`
- [x] Run: `vlc-binaries/vlc-4.0.0-dev/vlc.exe -vvv --intf hello_csharp`
- [x] Verify log output contains "C# Plugin initialized"
- [x] Verify clean shutdown (no crashes)

### Success Criteria
When running VLC with verbose logging, we should see:
```
[hello_csharp] C# Plugin initialized
[hello_csharp] C# Plugin cleaned up
```

---

## Phase 3: Player Events Integration - COMPLETED

### Priority 6: Add player functions to vlccore.def - COMPLETED
- [x] Added `vlc_playlist_GetPlayer` to vlccore.def
- [x] Added `vlc_player_Lock` and `vlc_player_Unlock` to vlccore.def
- [x] Added `vlc_player_AddListener` and `vlc_player_RemoveListener` to vlccore.def
- [x] Added `vlc_player_GetState` to vlccore.def
- [x] Regenerated vlccore.lib import library

### Priority 7: Implement C bridge functions for player access - COMPLETED
- [x] Created `csharp_bridge_get_player()` to get player from playlist
- [x] Created `csharp_bridge_player_lock()` and `csharp_bridge_player_unlock()`
- [x] Created `csharp_bridge_player_add_listener()` with callback forwarding
- [x] Created `csharp_bridge_player_remove_listener()`
- [x] Created `csharp_bridge_player_get_state()`
- [x] Implemented static `vlc_player_cbs` structure with state and media change callbacks

### Priority 8: Add C# VlcPlayer wrapper class - COMPLETED
- [x] Created `VlcPlayer.cs` with P/Invoke declarations for player functions
- [x] Implemented `OnPlayerStateChanged` and `OnMediaChanged` delegate types
- [x] Created managed wrapper that subscribes to player events
- [x] Implemented state enum mapping for player states

### Priority 9: Update PluginState to subscribe to state changes - COMPLETED
- [x] Updated `PluginState.cs` to create VlcPlayer instance on Open
- [x] Subscribed to `OnPlayerStateChanged` and `OnMediaChanged` events
- [x] Log player state changes and media changes to VLC log
- [x] Clean up player listener on Close

### Success Criteria
When running VLC with verbose logging and playing/pausing media, we should see:
```
[hello_csharp] Player state changed: PLAYING
[hello_csharp] Media changed
[hello_csharp] Player state changed: PAUSED
```

---

## Implemented Features

- VLC logging from C# (Info, Error, Warning, Debug)
- VLC variable creation and manipulation (integer and string types)
- Clean plugin lifecycle (Open/Close callbacks)
- React to VLC player events (state changes, media changes)

## Future Work (DEFERRED)

These are out of scope for the current goal:

- Control playback (`vlc_playlist_*`)
- Cross-platform support (Linux, macOS)
- Custom UI / Qt integration
- Subtitle rendering

---

## Decisions Made

1. **Plugin type**: Interface plugin (`set_capability("interface", 0)`)
2. **Naming**: `libhello_csharp_plugin.dll` for C glue, `VlcPlugin.dll` for C#
3. **Loading strategy**: C glue dynamically loads C# DLL
4. **License**: LGPL 2.1+
5. **P/Invoke strategy**: Use C bridge function for variadic VLC functions
6. **Plugin location**: `plugins/control/` subfolder

## Learnings

1. **vswhere.exe requirement**: Need in PATH for native AOT publish
2. **vlccore stub**: `vlccore_stub.c` provides stub for testing without VLC
3. **Variadic functions**: VLC logging uses variadic functions - wrap in C glue
4. **Circular dependency**: C# cannot DirectPInvoke to C glue that loads it; use runtime resolution
5. **Import library generation**: Use `llvm-dlltool -d vlccore.def -l vlccore.lib -m i386:x86-64` to create import library from DLL
6. **DLL path resolution**: Windows LoadLibrary doesn't automatically find DLLs in the same directory as the calling DLL; must use GetModuleHandleEx + GetModuleFileName to find the plugin directory and construct full path
7. **Plugin cache**: Run `vlc-cache-gen.exe plugins` after updating plugins to avoid "stale plugins cache" warning
8. **CRT heap incompatibility**: VLC (mingw/msvcrt) and our plugin (UCRT) use different heaps. Strings from VLC's `var_GetChecked` must be copied with `_strdup` before returning to C#, then freed with our own `free()`. Do NOT call `free()` on VLC-allocated memory directly - it causes heap corruption
9. **vlc_player_cbs structure**: Must match the order of callbacks in vlc_player.h exactly. The structure must include all callback slots even if NULL.

## References

- VLC plugin example: `vlc/modules/control/dummy.c`
- VLC 4.x API version: 4.0.6
- Plugin macros: `vlc/include/vlc/vlc_plugin.h`
