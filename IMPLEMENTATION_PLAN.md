# Implementation Plan

> Generated by planning phase. VLC 4.x API version: 4.0.6

## Overview

Build a native AOT C# plugin that integrates with VLC 4.x via a C glue layer. Start with a minimal "Hello World" interface plugin to prove the architecture, then expand.

## Architecture

```
VLC 4.x Plugin System
        │
        ▼
┌──────────────────────────┐
│  libhello_csharp_plugin  │  C glue (VLC-facing)
│  - vlc_module_begin/end  │
│  - Open() → bridges to   │──────┐
│  - Close() → C# exports  │      │
└──────────────────────────┘      │
                                  │ LoadLibrary + GetProcAddress
                                  ▼
┌──────────────────────────┐
│  VlcPlugin.dll (native)  │  C# Native AOT
│  - CSharpPluginOpen()    │
│  - CSharpPluginClose()   │
│  - Uses libvlccore       │──────┐
└──────────────────────────┘      │
                                  │ P/Invoke
                                  ▼
                          libvlccore.dll
```

---

## Phase 1: Minimal Viable Plugin (Proof of Concept)

### Priority 1: C# Native AOT Project Setup - COMPLETED
- [x] Create `src/VlcPlugin/VlcPlugin.csproj` with .NET 10, PublishAot=true
- [x] Create `src/VlcPlugin/PluginExports.cs` with `[UnmanagedCallersOnly]` exports:
  - `CSharpPluginOpen(nint vlcObject) → int`
  - `CSharpPluginClose(nint vlcObject) → void`
- [x] Create `src/VlcPlugin/PluginState.cs` for state management
- [x] Create `src/VlcPlugin/VlcInterop.cs` for UTF-8 string marshalling
- [x] Verify `dotnet publish -c Release -r win-x64` produces native DLL
- [x] Verify exports visible with `dumpbin /exports`

### Priority 2: C Glue Layer - COMPLETED
- [x] Create `src/glue/plugin_entry.c`:
  - `#define VLC_MODULE_LICENSE VLC_LICENSE_LGPL_2_1_PLUS`
  - `vlc_module_begin()` / `vlc_module_end()` block
  - `set_capability("interface", 0)`
  - `set_callbacks(Open, Close)`
- [x] Create `src/glue/csharp_bridge.h` - function pointer declarations
- [x] Create `src/glue/csharp_bridge.c`:
  - `csharp_bridge_init()` - LoadLibrary for VlcPlugin.dll
  - `csharp_bridge_resolve()` - GetProcAddress for exports
  - `csharp_bridge_cleanup()` - FreeLibrary
- [x] Create `src/glue/vlccore_stub.c` - stub for `vlc_object_Log` (testing only)
- [x] Verify C glue compiles with Clang

### Priority 3: Bridge Integration - COMPLETED
- [x] Implement Open callback in C glue → calls `csharp_plugin_open()`
- [x] Implement Close callback in C glue → calls `csharp_plugin_close()`
- [x] Handle bridge init failure gracefully (return VLC_EGENERIC)
- [x] Test with standalone test harness (`src/test/test_harness.c`)

### Priority 4: VLC Integration Test - PARTIAL
- [x] Both DLLs built successfully
- [x] Test harness verifies complete call chain works
- [ ] Copy both DLLs to VLC plugin directory
- [ ] Test discovery: `vlc -vvv --list` shows plugin
- [ ] Test loading: `vlc --intf hello_csharp` activates plugin
- [ ] Verify C# code executes (console output or log file)
- [ ] Verify clean shutdown (no crashes)

> **Note**: Final VLC integration test requires VLC 4.x binaries (not yet available).

---

## Phase 2: libvlccore Bindings

### Priority 5: ClangSharp Setup - PARTIALLY COMPLETED
- [x] Evaluated ClangSharp for automatic binding generation
- [ ] ~~Create `src/VlcPlugin/clangsharp.rsp` configuration~~
- [ ] ~~Run ClangSharpPInvokeGenerator on VLC headers~~
- [x] Manual P/Invoke bindings created instead

> **Note**: We didn't use ClangSharp as originally planned because the key VLC logging function (`vlc_object_Log`) uses variadic arguments which aren't directly supported by P/Invoke. Instead, we added a logging wrapper function to the C glue layer (`csharp_bridge_log`) that C# can call via P/Invoke. Manual P/Invoke bindings were created in `src/VlcPlugin/Native/VlcBridge.cs` and high-level wrapper in `src/VlcPlugin/VlcLogger.cs`.

### Priority 6: Use libvlccore from C# - IN PROGRESS
- [x] Replace Console.WriteLine with VLC logging (msg_Info via bindings)
- [ ] Create a VLC variable from C# to prove var_Create works
- [x] Verify P/Invoke calls succeed at runtime (no DllNotFoundException)

---

## Phase 3: Enhanced Plugin Functionality

### Priority 7: Proper Interface Plugin
- [ ] Implement persistent plugin (doesn't just return immediately)
- [ ] Create background thread if needed (intf_thread pattern)
- [ ] Register configuration options (add_bool, add_string in C glue)
- [ ] Respond to VLC events (event callbacks)

### Priority 8: libvlc API Access
- [ ] Verify plugin can be activated via libvlc (not just CLI)
- [ ] Test from external program using libvlc
- [ ] Document activation method

---

## Phase 4: Production Readiness

### Priority 9: Cross-platform Support
- [ ] Add Linux build support (dlfcn.h, .so naming)
- [ ] Add macOS build support (.dylib)
- [ ] Test on each platform

### Priority 10: Testing Infrastructure
- [ ] Create `src/VlcPlugin.Tests/` project
- [ ] Unit tests for PluginExports (mock vlc_object)
- [ ] Integration tests with real VLC (if feasible)
- [ ] CI/CD pipeline

---

## Decisions Made

1. **Plugin type**: Interface plugin (`set_capability("interface", 0)`)
2. **Naming**: `libhello_csharp_plugin.dll` for C glue, `VlcPlugin.dll` for C#
3. **Loading strategy**: C glue dynamically loads C# DLL (not static linking)
4. **License**: LGPL 2.1+ (compatible with VLC)
5. **P/Invoke strategy**: Use a C bridge function (`csharp_bridge_log`) instead of direct libvlccore P/Invoke for variadic functions

## Open Questions

1. Should we embed VlcPlugin.dll inside the C glue DLL, or ship as separate file?
2. How to handle VLC's threading model from C# managed code?
3. What's the minimum set of libvlccore functions needed for useful plugin?

## Learnings

1. **vswhere.exe requirement**: Need `vswhere.exe` in PATH for native AOT publish (or use VS Developer Command Prompt)
2. **NuGet configuration**: Created `nuget.config` to use only nuget.org source (avoid auth issues with other feeds)
3. **vlccore stub**: `vlccore_stub.c` provides `vlc_object_Log` stub for testing without VLC binaries
4. **Test harness**: `src/test/test_harness.c` simulates VLC's plugin loading sequence for validation
5. **Variadic functions and P/Invoke**: VLC's logging API uses variadic functions which cannot be directly P/Invoked from C#. Solution: add wrapper functions in the C glue layer that accept simple parameters and call the variadic VLC functions internally.
6. **Circular dependency and P/Invoke**: Circular dependency issue: C# DLL cannot use DirectPInvoke for the C glue DLL because the C glue DLL loads the C# DLL dynamically. Runtime P/Invoke resolution works when both DLLs are in the same directory.

## References

- VLC plugin example: `vlc/modules/control/dummy.c`
- VLC 4.x API version: 4.0.6
- Plugin macros: `vlc/include/vlc/vlc_plugin.h`
