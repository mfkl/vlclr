# Implementation Plan

> Generated by planning phase. VLC 4.x API version: 4.0.6

## Current Goal - ACHIEVED

**Get a C# log message to appear in real VLC 4 logs.**

Drop both DLLs into a VLC 4 installation and see "C# Plugin initialized" in VLC's log output.

All core phases (1-8) are complete. The plugin provides:
- VLC logging from C#
- Variable creation/manipulation
- Player event subscriptions
- Player seeking and playback control
- Playlist control
- Object management
- Generated bindings documentation
- Unit test suite (86 tests passing)

### Success Criteria Met
- [x] Plugin loads in VLC 4
- [x] C# log messages appear in VLC log output
- [x] Variable creation works
- [x] Player events work (state, position, media changes)
- [x] Player seeking works (time, position, pause/resume, can_seek/can_pause)
- [x] Playlist control works (start, stop, pause, resume, next, prev, goto)
- [x] Unit tests pass (86 tests)

## Architecture

```
VLC 4.x Plugin System
        │
        ▼
┌──────────────────────────┐
│  libhello_csharp_plugin  │  C glue (VLC-facing)
│  - vlc_module_begin/end  │
│  - Open() → bridges to   │──────┐
│  - Close() → C# exports  │      │
└──────────────────────────┘      │
                                  │ LoadLibrary + GetProcAddress
                                  ▼
┌──────────────────────────┐
│  VlcPlugin.dll (native)  │  C# Native AOT
│  - CSharpPluginOpen()    │
│  - CSharpPluginClose()   │
│  - Logs via bridge       │──────┐
└──────────────────────────┘      │
                                  │ P/Invoke callback
                                  ▼
                      csharp_bridge_log() in C glue
                                  │
                                  ▼
                          vlc_object_Log() in libvlccore.dll
```

---

## Deployment Target

```
vlc-4.0.0-dev/
├── vlc.exe
├── libvlccore.dll
└── plugins/
    └── control/
        ├── libhello_csharp_plugin.dll   ← C glue (copy here)
        └── VlcPlugin.dll                 ← C# Native AOT (copy here)
```

---

## Completed Phases (Summary)

### Phase 1: Minimal Viable Plugin ✓
C# Native AOT project with `[UnmanagedCallersOnly]` exports, C glue layer with VLC module macros, and bridge integration.

### Phase 2: Real VLC Integration ✓
Linked against real libvlccore.dll, deployed to VLC plugins/control/, verified logging works.

### Phase 3: Player Events Integration ✓
Player state/position/media change events via vlc_player_AddListener. C# VlcPlayer wrapper class.

### Phase 4: Playlist Control ✓
Full playlist control: start/stop/pause/resume, next/prev, goto, count, current index. C# VlcPlaylist wrapper.

### Phase 5: Unit Testing ✓
xUnit test project with 61 tests covering UTF-8 marshalling and API contract verification.

### Phase 6: Object Management ✓
VlcObject wrapper class with object hierarchy navigation (parent, typename, root traversal).

### Phase 7: Binding Documentation ✓
Created Generated/ directory with VlcTypes.cs, VlcConstants.cs, and documentation. Updated libvlccore-bindings.md spec to reflect C bridge architecture (ClangSharp doesn't work with VLC headers).

### Phase 8: Player Seeking and Playback Control ✓
Extended VlcPlayer with seeking functionality: Time/Length/Position properties, SeekByTime/SeekByPosition methods, Pause/Resume, CanSeek/CanPause properties. Added SeekSpeed and SeekWhence enums. 25 new unit tests (86 total).

---

## Implemented Features

- VLC logging from C# (Info, Error, Warning, Debug)
- VLC variable creation and manipulation (integer and string types)
- Clean plugin lifecycle (Open/Close callbacks)
- React to VLC player events (state changes, media changes)
- Player seeking and control (time, position, pause, resume, can_seek, can_pause)
- Playlist control (start, stop, pause, resume, next, prev, goto, count, current index)
- Object management (vlc_object_parent, vlc_object_typename)
- Unit test suite with xUnit (86 tests)

## Future Work (DEFERRED)

These are out of scope for the current goal:

- Cross-platform support (Linux, macOS)
- Custom UI / Qt integration
- Subtitle rendering

---

## Decisions Made

1. **Plugin type**: Interface plugin (`set_capability("interface", 0)`)
2. **Naming**: `libhello_csharp_plugin.dll` for C glue, `VlcPlugin.dll` for C#
3. **Loading strategy**: C glue dynamically loads C# DLL
4. **License**: LGPL 2.1+
5. **P/Invoke strategy**: Use C bridge function for variadic VLC functions
6. **Plugin location**: `plugins/control/` subfolder

## Learnings

1. **vswhere.exe requirement**: Need in PATH for native AOT publish
2. **vlccore stub**: `vlccore_stub.c` provides stub for testing without VLC
3. **Variadic functions**: VLC logging uses variadic functions - wrap in C glue
4. **Circular dependency**: C# cannot DirectPInvoke to C glue that loads it; use runtime resolution
5. **Import library generation**: Use `llvm-dlltool -d vlccore.def -l vlccore.lib -m i386:x86-64` to create import library from DLL
6. **DLL path resolution**: Windows LoadLibrary doesn't automatically find DLLs in the same directory as the calling DLL; must use GetModuleHandleEx + GetModuleFileName to find the plugin directory and construct full path
7. **Plugin cache**: Run `vlc-cache-gen.exe plugins` after updating plugins to avoid "stale plugins cache" warning
8. **CRT heap incompatibility**: VLC (mingw/msvcrt) and our plugin (UCRT) use different heaps. Strings from VLC's `var_GetChecked` must be copied with `_strdup` before returning to C#, then freed with our own `free()`. Do NOT call `free()` on VLC-allocated memory directly - it causes heap corruption
9. **vlc_player_cbs structure**: Must match the order of callbacks in vlc_player.h exactly. The structure must include all callback slots even if NULL.
10. **Playlist locking**: The playlist and player share the same lock (`vlc_playlist_Lock`/`vlc_playlist_Unlock`). All playlist operations must be performed within the lock.
11. **vlc_object_find_name deprecated**: The `vlc_object_find_name` function is not exported in VLC 4.x libvlccore. Object lookup should use alternative methods.

### Learnings
12. **ClangSharp and VLC headers**: VLC headers use complex C macros that break ClangSharp parsing. The C bridge approach is the correct architecture - types/constants are manually maintained in Generated/, function calls go through the C bridge.
13. **Type definition separation**: VlcLogType, VlcPlayerState, VlcVarType, and other enums/structs should live in `VlcPlugin.Generated` namespace only. Don't duplicate them in `VlcPlugin.Native` (VlcBridge.cs). All wrapper classes must import `using VlcPlugin.Generated;`.

---

## References

- VLC plugin example: `vlc/modules/control/dummy.c`
- VLC 4.x API version: 4.0.6
- Plugin macros: `vlc/include/vlc/vlc_plugin.h`
