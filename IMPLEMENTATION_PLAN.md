# Implementation Plan

> Generated by planning phase. VLC 4.x API version: 4.0.6

## Current Goal - .NET-ONLY FRAME MODIFICATION

**Make the video filter modify frames exclusively from .NET code, with reliable VLC testing.**

### Success Criteria
- [ ] C layer passes pixels to .NET without any pixel modification
- [ ] .NET layer renders and composites overlay onto video frames
- [ ] VLC test script runs with live stdout/stderr and auto-timeout
- [ ] Overlay visually confirmed on video playback

---

## Current Status

### Code Changes Already Made (Uncommitted)
The following changes exist in the working directory:

1. **`src/glue/video_filter_entry.c`**:
   - ✅ Removed `draw_red_rectangle()` function entirely
   - ✅ Removed all C-side pixel modification
   - ✅ Now calls ONLY `DotNetFilterFrame()` for frame processing
   - ✅ Changed debug file paths to current directory (not `C:\temp`)

2. **`src/VlcPlugin/FilterState.cs`**:
   - ✅ Changed debug path to `overlay_test.png` (current directory)

### Problem: Playback Doesn't Start

VLC Qt interface may not auto-play videos from command line. Need to:
1. Use `file:///` URL format
2. Use `--play-and-exit` flag
3. Possibly avoid Git Bash path mangling

---

## Phase A: Create VLC Test Runner

**Goal**: Reliable test script with live stdout/stderr and auto-timeout.

### Tasks
- [ ] Create `test-vlc-filter.ps1` PowerShell script
- [ ] Handle timeout with process kill
- [ ] Stream stderr to console in real-time
- [ ] Use `file:///` URL format for video path
- [ ] Test that script launches VLC and shows output

### Test Script Requirements
```powershell
# Must provide:
# 1. Live output streaming
# 2. Automatic timeout (default 10s)
# 3. Proper path handling
# 4. Exit code reporting
```

### Acceptance Criteria
- [ ] `.\test-vlc-filter.ps1` launches VLC
- [ ] Filter loading messages visible in output
- [ ] VLC auto-terminates after timeout
- [ ] No path-related errors

---

## Phase B: Verify .NET-Only Frame Modification

**Goal**: Confirm the overlay renders and composites correctly.

### Prerequisites
- Phase A complete (test runner working)

### Tasks
- [ ] Rebuild C glue (with draw_red_rectangle removed)
- [ ] Rebuild C# VlcPlugin
- [ ] Deploy to VLC plugins directory
- [ ] Regenerate plugin cache
- [ ] Run test script
- [ ] Verify debug files created:
  - `dotnet_filter_open.txt` (C Open called)
  - `dotnet_filter_frame.txt` (First frame info)
  - `overlay_test.png` (ImageSharp overlay)
- [ ] Visually confirm overlay on video

### Build Commands
```bash
# 1. Build C# Native AOT
export PATH="$PATH:/c/Program Files (x86)/Microsoft Visual Studio/Installer"
dotnet publish src/VlcPlugin -c Release -r win-x64

# 2. Build C glue
"C:/Program Files/LLVM/bin/clang.exe" -c -o build/video_filter_entry.o src/glue/video_filter_entry.c -I./vlc/include
"C:/Program Files/LLVM/bin/clang.exe" -shared -o build/libdotnet_filter_plugin.dll build/video_filter_entry.o build/vlccore.lib

# 3. Deploy
cp build/libdotnet_filter_plugin.dll vlc-binaries/vlc-4.0.0-dev/plugins/video_filter/
cp src/VlcPlugin/bin/Release/net10.0/win-x64/native/VlcPlugin.dll vlc-binaries/vlc-4.0.0-dev/plugins/video_filter/

# 4. Regenerate cache
./vlc-binaries/vlc-4.0.0-dev/vlc-cache-gen.exe ./vlc-binaries/vlc-4.0.0-dev/plugins
```

### Acceptance Criteria
- [ ] No C-side pixel modification in compiled plugin
- [ ] `[VlcPlugin] FilterState initialized` in stderr
- [ ] `overlay_test.png` generated with readable text
- [ ] Overlay visible on video in VLC window

---

## Phase C: Debug If Not Working

**Goal**: Diagnose issues if overlay doesn't appear.

### Diagnostic Steps (If Needed)
1. Check `dotnet_filter_open.txt` exists → proves Open() called
2. Check `dotnet_filter_frame.txt` exists → proves Filter() called
3. Check chroma format in debug file → I420 expected with `--no-hw-dec`
4. Check `overlay_test.png` exists and has content → proves ImageSharp works
5. If overlay PNG good but not on video → compositing issue
6. If no debug files → filter not being instantiated by VLC

### Common Issues
| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| No debug files | Filter not loaded | Check `vlc -vvv` output for filter loading |
| DX11 chroma | Hardware decoding | Ensure `--no-hw-dec` passed |
| 0 planes | GPU texture format | Software decoding required |
| PNG empty | Font loading failed | Check embedded resource |
| No visual overlay | Compositing bug | Check bytesPerPixel/chroma handling |

---

## Completed Phases (Phases 1-13)

### Phase 1-9: Core VLC Integration ✓
- C# Native AOT with VLC plugin exports
- Interface plugin with player events
- Playlist control, seeking, volume
- 94 unit tests passing

### Phase 10: Verify Filter Opens ✓
- Filter `Open()` confirmed via debug file
- DX11 opaque format detected with hardware decoding

### Phase 11: Minimal Frame Modification ✓
- Software decoding produces I420 with accessible planes
- C-side red rectangle test successful

### Phase 12-13: ImageSharp Integration ✓
- Font loading from embedded resource works
- Overlay PNG renders correctly
- Y-plane grayscale compositing implemented

---

## Learnings

1. **VLC 4.x requires `--no-hw-dec`** for CPU-accessible pixel formats
2. **Use `file:///` URLs** for reliable path handling in VLC
3. **Git Bash mangles paths** - use PowerShell or cmd.exe for VLC testing
4. **Debug with files, not console** - stderr may be lost
5. **I420 format** is YUV 4:2:0 planar - overlay converts to grayscale on Y plane
6. **Qt interface quirks** - may not auto-play from command line

---

## Build Dependencies

- Clang 21.1.8: `C:\Program Files\LLVM\bin\clang.exe`
- .NET 10.0.102: `dotnet publish`
- vswhere.exe in PATH for native AOT
- vlccore.lib in build/ directory

---

## References

- Spec: `specs/dotnet-only-frame-modification.md`
- Spec: `specs/vlc-test-runner.md`
- VLC filter examples: `vlc/modules/video_filter/invert.c`
