# Implementation Plan

> Generated by planning phase. VLC 4.x API version: 4.0.6

## Current Goal - ACHIEVED

**Get a C# log message to appear in real VLC 4 logs.**

Drop both DLLs into a VLC 4 installation and see "C# Plugin initialized" in VLC's log output.

All core phases (1-7) are complete. The plugin provides:
- VLC logging from C#
- Variable creation/manipulation
- Player event subscriptions
- Playlist control
- Object management
- Generated bindings documentation
- Unit test suite (61 tests passing)

### Success Criteria Met
- [x] Plugin loads in VLC 4
- [x] C# log messages appear in VLC log output
- [x] Variable creation works
- [x] Player events work (state, position, media changes)
- [x] Playlist control works (start, stop, pause, resume, next, prev, goto)
- [x] Unit tests pass (61 tests)

## Architecture

```
VLC 4.x Plugin System
        │
        ▼
┌──────────────────────────┐
│  libhello_csharp_plugin  │  C glue (VLC-facing)
│  - vlc_module_begin/end  │
│  - Open() → bridges to   │──────┐
│  - Close() → C# exports  │      │
└──────────────────────────┘      │
                                  │ LoadLibrary + GetProcAddress
                                  ▼
┌──────────────────────────┐
│  VlcPlugin.dll (native)  │  C# Native AOT
│  - CSharpPluginOpen()    │
│  - CSharpPluginClose()   │
│  - Logs via bridge       │──────┐
└──────────────────────────┘      │
                                  │ P/Invoke callback
                                  ▼
                      csharp_bridge_log() in C glue
                                  │
                                  ▼
                          vlc_object_Log() in libvlccore.dll
```

---

## Deployment Target

```
vlc-4.0.0-dev/
├── vlc.exe
├── libvlccore.dll
└── plugins/
    └── control/
        ├── libhello_csharp_plugin.dll   ← C glue (copy here)
        └── VlcPlugin.dll                 ← C# Native AOT (copy here)
```

---

## Completed Phases (Summary)

### Phase 1: Minimal Viable Plugin ✓
C# Native AOT project with `[UnmanagedCallersOnly]` exports, C glue layer with VLC module macros, and bridge integration.

### Phase 2: Real VLC Integration ✓
Linked against real libvlccore.dll, deployed to VLC plugins/control/, verified logging works.

### Phase 3: Player Events Integration ✓
Player state/position/media change events via vlc_player_AddListener. C# VlcPlayer wrapper class.

### Phase 4: Playlist Control ✓
Full playlist control: start/stop/pause/resume, next/prev, goto, count, current index. C# VlcPlaylist wrapper.

### Phase 5: Unit Testing ✓
xUnit test project with 61 tests covering UTF-8 marshalling and API contract verification.

### Phase 6: Object Management ✓
VlcObject wrapper class with object hierarchy navigation (parent, typename, root traversal).

### Phase 7: Binding Documentation ✓
Created Generated/ directory with VlcTypes.cs, VlcConstants.cs, and documentation. Updated libvlccore-bindings.md spec to reflect C bridge architecture (ClangSharp doesn't work with VLC headers).

---

## Implemented Features

- VLC logging from C# (Info, Error, Warning, Debug)
- VLC variable creation and manipulation (integer and string types)
- Clean plugin lifecycle (Open/Close callbacks)
- React to VLC player events (state changes, media changes)
- Playlist control (start, stop, pause, resume, next, prev, goto, count, current index)
- Object management (vlc_object_parent, vlc_object_typename)
- Unit test suite with xUnit (61 tests)

## Future Work (DEFERRED)

These are out of scope for the current goal:

- Cross-platform support (Linux, macOS)
- Custom UI / Qt integration
- Subtitle rendering

---

## Decisions Made

1. **Plugin type**: Interface plugin (`set_capability("interface", 0)`)
2. **Naming**: `libhello_csharp_plugin.dll` for C glue, `VlcPlugin.dll` for C#
3. **Loading strategy**: C glue dynamically loads C# DLL
4. **License**: LGPL 2.1+
5. **P/Invoke strategy**: Use C bridge function for variadic VLC functions
6. **Plugin location**: `plugins/control/` subfolder

## Learnings

1. **vswhere.exe requirement**: Need in PATH for native AOT publish
2. **vlccore stub**: `vlccore_stub.c` provides stub for testing without VLC
3. **Variadic functions**: VLC logging uses variadic functions - wrap in C glue
4. **Circular dependency**: C# cannot DirectPInvoke to C glue that loads it; use runtime resolution
5. **Import library generation**: Use `llvm-dlltool -d vlccore.def -l vlccore.lib -m i386:x86-64` to create import library from DLL
6. **DLL path resolution**: Windows LoadLibrary doesn't automatically find DLLs in the same directory as the calling DLL; must use GetModuleHandleEx + GetModuleFileName to find the plugin directory and construct full path
7. **Plugin cache**: Run `vlc-cache-gen.exe plugins` after updating plugins to avoid "stale plugins cache" warning
8. **CRT heap incompatibility**: VLC (mingw/msvcrt) and our plugin (UCRT) use different heaps. Strings from VLC's `var_GetChecked` must be copied with `_strdup` before returning to C#, then freed with our own `free()`. Do NOT call `free()` on VLC-allocated memory directly - it causes heap corruption
9. **vlc_player_cbs structure**: Must match the order of callbacks in vlc_player.h exactly. The structure must include all callback slots even if NULL.
10. **Playlist locking**: The playlist and player share the same lock (`vlc_playlist_Lock`/`vlc_playlist_Unlock`). All playlist operations must be performed within the lock.
11. **vlc_object_find_name deprecated**: The `vlc_object_find_name` function is not exported in VLC 4.x libvlccore. Object lookup should use alternative methods.

---

## Phase 6: Object Management - COMPLETED

### Priority 15: Add object management functions to vlccore.def - COMPLETED
- [x] Added `vlc_object_parent` to vlccore.def
- [x] Added `vlc_object_typename` to vlccore.def
- [x] Regenerated vlccore.lib import library

### Priority 16: Implement C bridge functions for object management - COMPLETED
- [x] Created `csharp_bridge_object_parent()` to get parent of VLC object
- [x] Created `csharp_bridge_object_typename()` to get object type name

### Priority 17: Add C# VlcObject wrapper class - COMPLETED
- [x] Created `VlcObject.cs` with wrapper methods for object hierarchy navigation
- [x] Added GetParent() and GetTypeName() instance methods
- [x] Added GetRoot() method to traverse to root object
- [x] Added static helper methods

### Priority 18: Expand unit test suite - COMPLETED
- [x] Added `VlcObjectTests.cs` with 10 tests for VlcObject class
- [x] Added `WrapperArchitectureTests.cs` with 34 tests for all wrapper classes
- [x] Total test count increased from 17 to 61

### Success Criteria
- VlcObject wrapper can navigate object hierarchy
- All 61 unit tests pass

---

## Phase 7: Binding Documentation - COMPLETED

### Goal
Document the binding architecture and create Generated/ directory structure per libvlccore-bindings.md spec.

### Findings
ClangSharp auto-generation doesn't work with VLC headers due to:
1. Complex macro systems (`VLC_API`, `VLC_FORMAT`, attribute macros) break ClangSharp parsing
2. Variadic functions (logging, etc.) cannot be called via P/Invoke directly
3. C bridge approach is required regardless

### Completed Work
- [x] Created `src/VlcPlugin/clangsharp.rsp` configuration (reference/documentation)
- [x] Created `src/VlcPlugin/Generated/VlcTypes.cs` with enums and structs
- [x] Created `src/VlcPlugin/Generated/VlcConstants.cs` with VLC constants
- [x] Created `src/VlcPlugin/Generated/README.md` explaining architecture
- [x] Updated `specs/libvlccore-bindings.md` to document C bridge architecture
- [x] All 61 tests still passing

### Learnings
12. **ClangSharp and VLC headers**: VLC headers use complex C macros that break ClangSharp parsing. The C bridge approach is the correct architecture - types/constants are manually maintained in Generated/, function calls go through the C bridge.

---

## References

- VLC plugin example: `vlc/modules/control/dummy.c`
- VLC 4.x API version: 4.0.6
- Plugin macros: `vlc/include/vlc/vlc_plugin.h`
